// GRID INIT
$grid-curr-margin: null !default;

@mixin setup-grid($output: true) {

  // merge defaults
  $base: map-merge(( margin-x: 1rem, ), if(variable-exists('base'), $base, ()));
  // get values and classes
  $margin-x: map-get($base, 'margin-x');
  // $margin-x: margin-x(); // don't assume media is setup
  $grid: map-get($layout-classes, 'grid');
  $cell: map-get($layout-classes, 'cell');

  // grid
  %#{$grid} {
    &:before { display: none; } // in case of salvattore
    width: calc(100% + #{$margin-x}); // necessary?
    margin-left: $margin-x / -2;
    margin-right: $margin-x / -2;
    position: relative; // for 'out' positioned cells which are absolute
    @if $grid-is-float {
      @include clearfix();
    } @else {
      font-size: 0rem;
      & > * { font-size: 1rem; }
      text-align: $grid-alignment;
    }
  }

  // cell
  %#{$cell} {
    min-height: 1px; // http://css-tricks.com/make-sure-columns-dont-collapse-horizontally/
    padding-left: $margin-x / 2;
    padding-right: $margin-x / 2;
    @if $grid-is-float {
      display: block;
      float: $grid-alignment;
    } @else {
      width: 100%;
      display: inline-block;
      vertical-align: top;
    }
  }

  @if variable-exists('media') {
    @each $alias, $medium in $media {
      @if map-has-key(medium-orig($alias), 'margin-x') {
        @include medium($alias) {
          $margin-x: margin-x();

          // grid
          %#{$grid} {
            width: calc(100% + #{$margin-x}); // necessary?
            margin-left: $margin-x / -2;
            margin-right: $margin-x / -2;
          }

          // cell
          %#{$cell} {
            padding-left: $margin-x / 2;
            padding-right: $margin-x / 2;
          }
        }
      }
    }
  }

  @if $output {
    .#{$grid} { @extend %#{$grid}; }
    .#{$cell} { @extend %#{$cell}; }
  }
}

// GRID MIXINS

// grid
@mixin grid($margin: null, $columns: null) {
  @if $columns { &::before { content: '#{$columns} .#{map-get($layout-classes, 'cell')}'; } }
  @extend %#{map-get($layout-classes, 'grid')};
  @if $margin {
    @include media((for: margin-x)) {
      margin-left: margin-x($margin) / -2;
      margin-right: margin-x($margin) / -2;
    }
    $grid-prev-margin: $grid-curr-margin;
    $grid-curr-margin: $margin !global;
    @at-root { @content; }
    $grid-curr-margin: $grid-prev-margin !global;
  }
}

// cell beta
// @mixin cell($span: null, $margin: $grid-curr-margin) {
//   @if type-of($span) == 'map' { @include cell($span...); }
//   @extend %#{map-get($layout-classes, 'cell')};
//   @if $margin {
//     @include media((for: margin-x)) {
//       padding-left: margin-x($margin) / 2;
//       padding-right: margin-x($margin) / 2;
//     }
//   }
//   @if length($span) > 0 { @include span($span...); }
// }

// cell
@mixin cell($margin: $grid-curr-margin, $span...) {
  @extend %#{map-get($layout-classes, 'cell')};
  @if $margin {
    @include media((for: margin-x)) {
      padding-left: margin-x($margin) / 2;
      padding-right: margin-x($margin) / 2;
    }
  }
  @if length($span) > 0 { @include span($span...); }
}

// span
@mixin span($span: 1 1, $options: ()) { @include span-helper(map-merge((span: $span), $options)...); }
@mixin span-helper($span, $right: null, $left: null, $out: null, $cycle: null) {
  $n: nth($span, 1); $d: nth($span, 2);

  width: $n / $d * 100%;

  @if $right { margin-right: nth($right, 1) / if(length($right) > 1, nth($right, 2), $d) * 100%; }
  @if $left { margin-left: nth($left, 1) / if(length($left) > 1, nth($left, 2), $d) * 100%; }
  @if $cycle { &:nth-child(#{$cycle}n+1) { clear: left; } }
  @else if $out { position: absolute; #{opposite($out)}: 100%; top: auto; }
}
