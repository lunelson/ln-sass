///////////
// fonts //
///////////

@mixin font-face($family, $dir, $file, $style, $weight) {
  @font-face {
    font-family: $family;
    font-style: $style;
    font-weight: $weight; // this should be both word and number values
    src: url('#{$dir}#{$file}.eot'); // IE9 Compat Modes
    src: url('#{$dir}#{$file}.eot?#iefix') format('embedded-opentype'),
       url('#{$dir}#{$file}.svg##{$file}') format('svg');
       //url('#{$dir}#{$file}.woff') format('woff'),
       // url('#{$dir}#{$file}.svg##{$file}') format('svg'),
       // url('#{$dir}#{$file}.ttf') format('truetype');
  }
}

@mixin font() {}

//////////////////
// stack / typo //
//////////////////

$curr-stack-sel: null !default;

@mixin stack($m: $curr-mult-y-key, $s: $curr-size-key, $l: $curr-line-key, $f: $curr-font-key, $typo: true) {

  $prev-mult-y-key: $curr-mult-y-key;
  $prev-size-key: $curr-size-key;
  $prev-line-key: $curr-line-key;
  $prev-font-key: $curr-font-key;

  $curr-mult-y-key: $m !global;
  $curr-size-key: $s !global;
  $curr-line-key: $l !global;
  $curr-font-key: $f !global;

  // $parent-sel: &;
  // $curr-stack-sel: $parent-sel !global;
  $curr-stack-sel: & !global;

  // if we're not at root level
  // @if $parent-sel {
  // }
  padding-top: 0.1px;
  padding-bottom: 0.1px;
  & > * { margin-top: 0; margin-bottom: 0; }
  & > * + * { margin-top: margin-y($m); }

  // output content, nested or not
  @content;

  // restore prevs globally
  // $curr-stack-sel: false !global;
  $curr-stack-sel: null !global;
  // $stack-typo-item-sel: null !global;
  $curr-mult-y-key: $prev-mult-y-key !global;
  $curr-size-key: $prev-size-key !global;
  $curr-line-key: $prev-line-key !global;
  $curr-font-key: $prev-font-key !global;
}

// BLOCKS

@mixin typo-item($s: $curr-size-key, $l: $curr-line-key, $f: $curr-font-key) {

  $same-size-key: ($s == $curr-size-key);
  $same-line-key: ($l == $curr-line-key);
  $same-font-key: ($f == $curr-font-key);

  $prev-size-key: $curr-size-key;
  $prev-line-key: $curr-line-key;
  $prev-font-key: $curr-font-key;

  $curr-size-key: $s !global;
  $curr-line-key: $l !global;
  $curr-font-key: $f !global;

  $size: size($s);
  $line: line($l);
  $font: if($f, font($f), null);

  $font-family: if($font, map-get($font, 'font-family'), null);
  $size-adjust: if($font, map-get($font, 'size-adjust') or 1, 1);
  // font: inspect($f);
  font-family: $font-family;
  line-height: $line * medium-value('line-height');
  // font-size: unit-assert($size, if($curr-stack-sel, 'em', 'rem')) * $size-adjust;



  @if $curr-stack-sel {
    font-size: unit-assert($size, em) * $size-adjust;
    @at-root #{sel-insert-parents('','>')} {
      margin-top: typo-em-margin(0);
      margin-bottom: typo-em-margin(0);
      @include adj-to() { margin-top: typo-ex-margin(); }
      @content;
    }
    // & > #{$typo-sel}/* , & > .typo */ { margin-top: typo-em-margin(0); margin-bottom: typo-em-margin(0); }
    // & > * + #{$typo-sel}/* , & > * + .typo */ { margin-top: typo-ex-margin(); }

    // // if we are inside a block
    // @extend #{$stack-typo-item-sel};
    // @content;
  } @else {
    // if we are at root level
    @each $m, $mult in map-merge((base: 1), medium-value('mults-y') or medium-value('mults')) {
      $stack-sel: '.stack#{mult-class($m)}';
      @at-root #{sel-insert-parents($stack-sel)} {
        font-size: unit-assert($size, em) * $size-adjust;
      }
      @at-root #{sel-insert-parents($stack-sel,'>')} {
        margin-top: typo-em-margin(0);
        margin-bottom: typo-em-margin(0);
        @include adj-to() { margin-top: typo-ex-margin(if($m=='base',1,$m)); }
        @content;
      }
    }
  }

  $curr-size-key: $prev-size-key !global;
  $curr-line-key: $prev-line-key !global;
  $curr-font-key: $prev-font-key !global;
}
