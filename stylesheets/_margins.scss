//                                                           88
//                                                           ""
//
//  88,dPYba,,adPYba,   ,adPPYYba,  8b,dPPYba,   ,adPPYb,d8  88  8b,dPPYba,
//  88P'   "88"    "8a  ""     `Y8  88P'   "Y8  a8"    `Y88  88  88P'   `"8a
//  88      88      88  ,adPPPPP88  88          8b       88  88  88       88
//  88      88      88  88,    ,88  88          "8a,   ,d88  88  88       88
//  88      88      88  `"8bbdP"Y8  88           `"YbbdP"Y8  88  88       88
//                                               aa,    ,88
//                                                "Y8bbdP"

// GLOBALS
$margin-defaults: (
  'offset' 3,
  'range' 10,
  'spread' 3,
) !default;

///////////////
// FUNCTIONS //
///////////////

// MAIN for margin-y
@function get-margin($index: 0, $sub-index: 0, $query-alias: $current-query-alias) {
  $margin: if($query-alias, get($queries, $query-alias, 'margin-y'), get($base, 'margin-y'));
  @if length($margin) > 1 {
    $offset: get($margin-defaults, 'offset');
    $spread: get($margin-defaults, 'spread');
    $target: ($index + $offset) * $spread + $sub-index;
    @return nth($margin, $target);
  }
  @return $margin;
}

// alias
@function margin($args...) { @return get-margin($args...); }

// ALT for margin-x
@function get-margin-x($index: 0, $sub-index: 0, $query-alias: $current-query-alias) {
  $margin: if($query-alias, get($queries, $query-alias, 'margin-x'), get($base, 'margin-x'));
  @if length($margin) > 1 {
    $offset: get($margin-defaults, 'offset');
    $spread: get($margin-defaults, 'spread');
    $target: ($index + $offset) * $spread + $sub-index;
    @return nth($margin, $target);
  }
  @return $margin;
}

// alias
@function margin-x($args...) { @return get-margin-x($args...); }

//////////////////////////////////////
// ========================= MIXINS //
//////////////////////////////////////

// SUBMIX
@mixin merge-margins($margins, $query-alias: null) {

  // get context margin-y value; fallback to line-height or just 1.5rem
  $context: get-query($query-alias);
  $margin-y: get($context, 'margin-y') or get($context, 'line-height') * 1rem or 1.5rem;
  $margin-x: get($context, 'margin-x') or 1rem;

  // calc and hold context margin lists
  $margins-y: (); $margins-x: ();
  @each $margin in $margins {
    $margins-y: append($margins-y, $margin * $margin-y, 'comma');
    $margins-x: append($margins-x, $margin * $margin-x, 'comma');
  }

  // put these together
  $margin-data: ('margin-y' $margins-y, 'margin-x' $margins-x);

  // merge them back to appropriate data
  @if $query-alias { $queries: merge($queries, $query-alias, $margin-data); }
  @else { $base: merge($base, $margin-data); }
}

// MASTER
@mixin setup-margins($options...) {

  // options and defaults
  $factor: get($options, 'factor') or 2;
  $steps: get($options, 'steps') or 3;
  $range: get($margin-defaults, 'range') or 10;
  $spread: get($margin-defaults, 'spread') or 3;
  $offset: get($margin-defaults, 'offset');
  $from-query: map-get($options, 'from') or null;
  $to-query: map-get($options, 'to') or null;

  // corrections
  @if contains(root base null, $from-query) { $from-query: null; }
  @if not $offset { $offset: floor($range / 3); $size-defaults: merge($size-defaults, 'offset' $offset); }

  // calculate the margin-list, unitless
  $margins: (); @for $n from 1 through $range * $spread {
    $margin: m-scale($n - $offset * $spread, $factor, $steps * $spread);
    $margins: append($margins, $margin, 'comma'); // unitless, at first
  }

  // conditional: base actions via submixin
  @if $from-query == null { @include merge-margins($margins); }

  // determine referenced queries
  $query-aliases: map-keys($queries);
  $sliced-aliases: slice($query-aliases,
      if($from-query, index($query-aliases, $from-query), 1),
      if($to-query, index($query-aliases, $to-query) - 1, length($query-aliases)));

  // per referenced query actions
  $count: 1; @each $query-alias in $sliced-aliases {
    @include merge-margins($margins, $query-alias);
    @if $count == 1 and $from-query != null { $queries-orig: merge($queries-orig, $query-alias, ('margin-bp' true)); }
    $count: $count + 1;
  }
}