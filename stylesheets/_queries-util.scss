//                                                                                                 88  88
//                                                                                          ,d     ""  88
//                                                                                          88         88
//   ,adPPYb,d8  88       88   ,adPPYba,  8b,dPPYba,  8b       d8            88       88  MM88MMM  88  88
//  a8"    `Y88  88       88  a8P_____88  88P'   "Y8  `8b     d8'  aaaaaaaa  88       88    88     88  88
//  8b       88  88       88  8PP"""""""  88           `8b   d8'   """"""""  88       88    88     88  88
//  "8a    ,d88  "8a,   ,a88  "8b,   ,aa  88            `8b,d8'              "8a,   ,a88    88,    88  88
//   `"YbbdP'88   `"YbbdP'Y8   `"Ybbd8"'  88              Y88'                `"YbbdP'Y8    "Y888  88  88
//           88                                           d8'
//           88                                          d8'

// vars to hold current queries
$current-query-alias: null;
$current-height-query-alias: null;

///////////////////
// WIDTH QUERIES //
///////////////////

// width query string function
@function query-string($alias1: null, $alias2: null) {
  @return 'screen'
    + if($alias1, ' and (min-width: #{get($queries, $alias1, min-width)})', '')
    + if($alias2, ' and (max-width: #{get($queries, $alias2, min-width) - 0.001})', '');
}

// retrieve current width query object
@function get-query($query-alias: $current-query-alias) {
  @if $query-alias { @return get($queries, $query-alias); }
  @return $base;
}

// function to retrieve current query-data-object based on $current-query-alias
@function get-orig-query($query-alias: $current-query-alias) {
  @if $query-alias { @return get($queries-orig, $query-alias); }
  @return $base;
}

// function to retrieve value for current query
@function get-query-value($key, $alias: $current-query-alias) {
  @return get(get-query($alias), $key);
}

// aliases
@function query-value($args...) { @return get-query-value($args...); }
@function qval($args...) { @return get-query-value($args...); }

////////////////////
// HEIGHT QUERIES //
////////////////////

// height query string function
@function height-query-string($alias1: null, $alias2: null) {
  @return 'screen'
    + if($alias1, ' and (min-height: #{get($height-queries, $alias1, min-width)})', '')
    + if($alias2, ' and (max-height: #{get($height-queries, $alias2, min-width) - 0.001})', '');
}

// retrieve current height query object
@function get-height-query($query-alias: $current-height-query-alias) {
  @if $query-alias { @return get($height-queries, $query-alias); }
  @return $base;
}

// function to retrieve value for current query
@function get-height-query-value($key, $alias: $current-height-query-alias) {
  @return get(get-query($alias), $key);
}

// aliases
@function height-query-value($args...) { @return get-height-query-value($args...); }
@function hqval($args...) { @return get-height-query-value($args...); }

///////////////////////////////////////////////////
// UNIT CONVERSION -- DEPENDENT on WIDTH QUERIES //
///////////////////////////////////////////////////

// function to convert value(s) to rem, following context scale
@function rem($values...) {
  @if $values == null { @return null; }
  $scale: get-query-value('html-scale');
  $unit: if(get($global, 'em-for-rem'), 'em', 'rem');
  $out: ();
  @each $value in $values {
    @if index('rem' 'em', unit($value)) { $out: append($out, assert($value, $unit), 'space'); }
    @else { $out: append($out, assert($value / $scale / 16, $unit), 'space'); }
  }
  @return if(length($out) > 1, $out, nth($out, 1));
}

// function to convert value(s) to px, following context scale
@function px($values...) {
  @if $values == null { @return null; }
  $scale: get-query-value('html-scale');
  $out: ();
  @each $value in $values {
    @if unit($value) == 'px' { $out: append($out, $value, 'space'); }
    @else { $out: append($out, assert($value * $scale * 16, 'px'), 'space'); }
  }
  @return if(length($out) > 1, $out, nth($out, 1));
}

////////////////////////
// WIDTH QUERY MIXINS //
////////////////////////

// mixin to output width media query
@mixin query($aliases...) {

  // save the context (not really necessary cause there's no nesting)
  $query-temp: $current-query-alias;

  // save current alias or at least the previous one if in max-width query
  // @if length($aliases) > 0 { $current-query-alias: nth($aliases, 1) or map-prev-key($queries, nth($aliases, 2)); }
  // TODO: revert the line above, remove line below, when map-prev-key is implemented
  $current-query-alias: nth($aliases, 1);

  // run the content in context
  @media #{query-string($aliases...)} { @content }

  // reset the context (no nesting; could just reset to null)
  $current-query-alias: $query-temp;
}

// hd width query
@mixin query-hd($aliases...) {

  // compute the hd-ratio shite
  $hd-ratio: get($global, 'hd-ratio');
  $n: nth($hd-ratio, 1);
  $d: nth($hd-ratio, 2);
  $ratio: $n/$d;

  // save the context (not really necessary cause there's no nesting)
  $query-temp: $current-query-alias;

  // save current alias or at least the previous one if in max-width query
  @if length($aliases) > 0 { $current-query-alias: nth($aliases, 1) or map-prev-key($queries, nth($aliases, 2)); }

  // run the content in context
  @media
    #{query-string($aliases...)} and (-webkit-min-device-pixel-ratio: $ratio),
    #{query-string($aliases...)} and (min--moz-device-pixel-ratio: $ratio),
    #{query-string($aliases...)} and (-o-min-device-pixel-ratio: #{$n}/#{$d}),
    #{query-string($aliases...)} and (min-device-pixel-ratio: $ratio),
    #{query-string($aliases...)} and (min-resolution: $ratio * 96dpi),
    #{query-string($aliases...)} and (min-resolution: $ratio * 1dppx) {
    @content;
  }

  // reset the context (no nesting; could just reset to null)
  $current-query-alias: $query-temp;
}

// multi width query -- combines both query-each() and query-for()
@mixin queries($options:()) {

  // get 'from', 'to' and 'keys'
  $from-query: get($options, 'from') or null;
  $to-query: get($options, 'to') or null;
  $keys: get($options, 'keys') or null;

  // transform/correct options
  @if contains(root base null, $from-query) { $from-query: null; }
  @if contains-any($keys, margin margin-y margins) { $keys: join($keys, margin-bp margin-y)}
  @if contains-any($keys, size sizes) { $keys: join($keys, size-bp font-size); }
  @if contains-any($keys, trim height line-height) { $keys: join($keys, line-height size-bp); }

  // conditional base action
  @if $from-query == null {
    @if $keys == null { @content; }
    @else if contains-any(keys($base), $keys) { @content; }
  }

  // determine referenced queries
  $query-aliases: map-keys($queries);
  $sliced-aliases: slice($query-aliases,
      if($from-query, index($query-aliases, $from-query), 1),
      if($to-query, index($query-aliases, $to-query) - 1, length($query-aliases)));

  // conditional per-query actions
  @each $query-alias in $sliced-aliases {
    @if not $keys { @include query($query-alias) { @content; } }
    @else if contains-any(keys(value($query)), $keys) { @include query($query-alias) { @content; } }
  }
}

// do each with query in a from/to range
@mixin query-each($options:()) {

  // get and correction options
  $from-query: get($options, 'from') or null;
  $to-query: get($options, 'to') or null;
  @if contains(root base null, $from-query) { $from-query: null; }

  // conditional base action
  @if $from-query == null { @content; }

  // determine referenced queries
  $query-aliases: map-keys($queries);
  $sliced-aliases: slice($query-aliases,
      if($from-query, index($query-aliases, $from-query), 1),
      if($to-query, index($query-aliases, $to-query) - 1, length($query-aliases)));

  // per referenced query actions
  @each $query-alias in $sliced-aliases {
    @include query($query-alias) { @content; }
  }
}

// do each query where certain keys exist in original spec
@mixin query-for($keys...) {
  @if contains-any($keys, margin margin-y margins) { $keys: join($keys, margin-bp margin-y)}
  @if contains-any($keys, size sizes) { $keys: join($keys, size-bp font-size); }
  @if contains-any($keys, trim height line-height) { $keys: join($keys, line-height size-bp); }
  @content;
  @each $query in $queries-orig {
    @if contains-any(keys(value($query)), $keys) {
      @include query(key($query)) {
        @content;
      }
    }
  }
}

/////////////////////////
// HEIGHT QUERY MIXINS //
/////////////////////////

// mixin to output height media query
@mixin height-query($aliases...) {
  // save the context (not really necessary cause there's no nesting)
  $query-temp: $current-height-query-alias;
  @if length($aliases) > 0 {
    // get current alias or at least the previous one if in max-height query
    $alias: nth($aliases, 1) or map-prev-key($height-queries, nth($aliases, 2));
    // set current context to height plus alias
    $current-height-query-alias: $alias;
  }
  // run the content in context
  @media #{query-string-y($aliases...)} { @content }
  // reset the context (no nesting; could just reset to null)
  $current-height-query-alias: $query-temp;
}