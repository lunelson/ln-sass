//                        _
//                       (_)
//   __ _ _   _  ___ _ __ _  ___  ___
//  / _` | | | |/ _ \ '__| |/ _ \/ __|
// | (_| | |_| |  __/ |  | |  __/\__ \
//  \__, |\__,_|\___|_|  |_|\___||___/
//     | |
//     |_|

$queries: (
  alpha: (
    min-width: 20em
  ),
  beta: (
    min-width: 30em
  ),
  gamma: (
    min-width: 48em
  ),
  delta: (
    min-width: 64em
  ),
  epsilon: (
    min-width: 80em
  )
) !default;

// height queries
$height-queries: () !default;

// backup maps
$queries-orig: ();
$height-queries-orig: ();

@mixin setup-queries($output: true){

  // backup data first
  $queries-orig: $queries;

  @if $queries != () {

    // sort
    // TODO: implement map-sort() for native maps
    // $queries: map-sort($queries, 'min-width');

    // parse width-queries relative to base properties
    $reference-spec: $base;

    @each $alias, $spec in $queries {

      // merge query to reference
      $reference-spec: merge($reference-spec, $spec);

      // get font-size for reference
      $font-size: get($reference-spec, 'font-size');

      // proof/convert values other than font-size and line-height
      @each $prop, $value in map-remove($reference-spec, 'font-size', 'min-width') {
        @if unit($value) == 'px' { $reference-spec: merge($reference-spec, $prop, $value / $font-size * 1rem); }
      }

      // do other values
      $html-scale: $font-size / 16px;
      $min-width: get($reference-spec, 'min-width');
      $content-width: strip($min-width) / $html-scale - get($reference-spec, 'page-left') - get($reference-spec, 'page-right');
      $reference-spec: merge($reference-spec, (
        'html-scale': $html-scale,
        'content-width': $content-width
      ));

      // merge it all back to queries
      $queries: merge($queries, $alias, $reference-spec);

      // output values for whatever appeared in query-spec
      @if $output {

        $font-size: get($spec, 'font-size');
        $line-height: get($spec, 'line-height');
        $margin-x: get($spec, 'margin-x');
        $margin-y: get($spec, 'margin-y');
        $page-top: get($spec, 'page-top');
        $page-right: get($spec, 'page-right');
        $page-bottom: get($spec, 'page-bottom');
        $page-left: get($spec, 'page-left');

        @include query($alias) {

          // output for JS; ref: http://dropshado.ws/post/79494424279/conditional-css-doesnt-work-in-chrome
          head { font-family: '#{$alias}'; }

          // output CSS if spec'd by user
          @if $font-size { html { font-size: percentage($html-scale); } }
          @if $line-height { body { line-height: $line-height; } }
          @if $page-top { body { margin-top: $page-top; } }
          @if $page-bottom { body { margin-bottom: $page-bottom; } }
          @if $page-right {
            .page-col { margin-right: $page-right; }
            .page-row { margin-right: - $page-right; }
          }
          @if $page-left {
            .page-col { margin-left: $page-left; }
            .page-row { margin-left: - $page-left; }
          }
        }
      }
    }
  }
}

@mixin setup-height-queries($output: true){

  // backup data first
  $height-queries-orig: $height-queries;

  @if $height-queries != () {

    // parse height-queries relative to empty properites
    $height-queries: map-sort($height-queries, 'min-height');
    $reference-spec: ();
    @each $query in $height-queries {
      $alias: tuple-key($query);
      $spec: tuple-value($query);

      // merge query to reference, merge this back to source
      $reference-spec: merge($reference-spec, $spec);
      $height-queries: merge($height-queries, $alias, $reference-spec);
    }
  }
}

//           88              88
//           88              88
//           88              88
//   ,adPPYb,88   ,adPPYba,  88,dPPYba,   88       88   ,adPPYb,d8
//  a8"    `Y88  a8P_____88  88P'    "8a  88       88  a8"    `Y88
//  8b       88  8PP"""""""  88       d8  88       88  8b       88
//  "8a,   ,d88  "8b,   ,aa  88b,   ,a8"  "8a,   ,a88  "8a,   ,d88
//   `"8bbdP"Y8   `"Ybbd8"'  8Y"Ybbd8"'    `"YbbdP'Y8   `"YbbdP"Y8
//                                                      aa,    ,88
//                                                       "Y8bbdP"


// @if $debug-toggle {
//   $column-count: get($reference-query, column-count);
//   $margin-x: get($reference-query, margin-x);
//   body::before { content: '#{$alias}'; }
//   body::after {
//     $row-width: $content-width + $margin-x;
//     width: $row-width; margin-left: ($row-width + $margin-x)/-2;
//     background: linear-gradient(to right,
//       rgba(0, 0, 0, 0) $margin-x,
//       $debug-color $margin-x,
//       $debug-color $row-width / $column-count - $margin-x
//     );
//     background-size: $row-width / $column-count;
//   }
// }

// // output stuff for the debug
// @if $debug-toggle {
//   body {
//     &:before, &:after {
//       position: fixed;
//       pointer-events: none;
//       user-select: none;
//       z-index: 999;
//     }
//     &:before {
//       text-align: right;
//       padding: 0.25rem;
//       width: 100%;
//       display: block;
//       color: black;
//       bottom: 0;
//       background-color: $debug-color;
//     }
//     &:after {
//       content: '';
//       top: 0;
//       bottom: 0;
//       left: 50%;
//     }
//   }
// }
