//                                                           88
//                                                           ""
//
//  88,dPYba,,adPYba,   ,adPPYYba,  8b,dPPYba,   ,adPPYb,d8  88  8b,dPPYba,
//  88P'   "88"    "8a  ""     `Y8  88P'   "Y8  a8"    `Y88  88  88P'   `"8a
//  88      88      88  ,adPPPPP88  88          8b       88  88  88       88
//  88      88      88  88,    ,88  88          "8a,   ,d88  88  88       88
//  88      88      88  `"8bbdP"Y8  88           `"YbbdP"Y8  88  88       88
//                                               aa,    ,88
//                                                "Y8bbdP"

// GLOBALS
$margin-assignments: () !default; // map of alias->index assignments
$margin-defaults: (
  'assignments' (),
  'default' m3,
  'offset' 3,
  'range' 6,
  'spread' 2,
  'superclasses' (kilo mega giga tera),
) !default;
$margin-default: m3 !default;

///////////////
// FUNCTIONS //
///////////////

// HELPER
@function get-margin-assignment($reference, $offset: 0) {
  $index: map-get($margin-assignments, $reference);
  @return $index + $offset;
}

// MAIN
@function get-margin($reference: get($margin-defaults, default)) {
  $index: null;
  @if type-of($reference) == 'list' { $index: get-margin-assignment($reference...); }
  @else { $index: get-margin-assignment($reference); }
  @return nth(get(get-query(),'margin-y'), $index);
}

@function margin2($index: 0, $sub-index: 0) {
  $offset: get($margin-defaults, 'offset');
  $spread: get($margin-defaults, 'spread');
  $target: ($index + $offset) * $spread + $sub-index;
  @return nth(get(get-query(),'margin-y'), $target);
}

// ALT for X margins
@function get-margin-x($reference: get($margin-defaults, default)) {
  $index: null;
  @if type-of($reference) == 'list' { $index: get-margin-assignment($reference...); }
  @else { $index: get-margin-assignment($reference); }
  @return nth(get(get-query(),'margin-x'), $index);
}


////////////
// MIXINS //
////////////

// SUBMIX
@mixin assign-margins() {

  // resolve data
  $range: get($margin-defaults, 'range');
  $spread: get($margin-defaults, 'spread');
  $superclasses: get($margin-defaults, 'superclasses');

  // create margin assignments
  @for $n from 1 through $range {
    // $n: $range - $n + 1; $index: ($range - $n + 1) * $spread; // inverted
    $index: $n * $spread;
    $margin-assignments: merge($margin-assignments, 'm#{$n}', $index);
  }

  // create super margin assignments
  @for $n from 1 through length($superclasses) {
    $index: ($range + $n) * $spread;
    $margin-assignments: merge($margin-assignments, '#{nth($superclasses, $n)}' $index);
  }
}

// SUBMIX
@mixin merge-margins($margins, $query-alias: null) {

  // get context margin-y value; fallback to line-height or just 1.5rem
  $context: get-query($query-alias);
  $margin-y: get($context, 'margin-y') or get($context, 'line-height') * 1rem or 1.5rem;
  $margin-x: get($context, 'margin-x') or 1rem;

  // calc and hold context margin lists
  $margins-y: (); $margins-x: ();
  @each $margin in $margins {
    $margins-y: append($margins-y, $margin * $margin-y, 'comma');
    $margins-x: append($margins-x, $margin * $margin-x, 'comma');
  }

  // put these together
  $margin-data: ('margin-y' $margins-y, 'margin-x' $margins-x);

  // merge them back to appropriate data
  @if $query-alias { $query-data: merge($query-data, nth($query-alias, 1), nth($query-alias, 2), $margin-data); }
  @else { $base-data: merge($base-data, $margin-data); }
}

// MASTER
@mixin setup-margins-per-query($query-aliases: null, $options:()) {

  // options
  $factor: get($options, 'factor') or 2;
  $steps: get($options, 'steps') or 3;

  // defaults
  $range: get($margin-defaults, 'range') or 6;
  $spread: get($margin-defaults, 'spread') or 2;
  $offset: get($margin-defaults, 'offset') or 1;
  $superclasses: get($margin-defaults, 'superclasses') or kilo mega giga tera;

  // query-aliases
  $query-alias1: nth($query-aliases, 1); $query-alias2: null;
  @if length($query-aliases) > 1 { $query-alias2: nth($query-aliases, 2); }

  // calculate the margin-list, unitless
  $margins: (); @for $n from 1 through (6 + length($superclasses)) * $spread {
    $margin: m-scale($n - $offset * $spread, $factor, $steps * $spread);
    $margins: append($margins, $margin, 'comma');
  }

  // conditional: base actions
  @if $query-alias1 == null { @include merge-margins($margins); }

  // conditional: per query actions
  $query-aliases: map-keys(map-get($query-data, 'width')); $count: 1;
  @each $query-alias in slice($query-aliases,
      if($query-alias1, index($query-aliases, $query-alias1), 1),
      if($query-alias2, index($query-aliases, $query-alias2) - 1, length($query-aliases))) {
    @include merge-margins($margins, 'width' $query-alias);
    @if $count == 1 and $query-alias1 != null { $query-orig: merge($query-orig, 'width', $query-alias, ('margin-bp' true)); }
    $count: $count + 1;
  }
  @include assign-margins();
}

// ALIAS
@mixin setup-margins($options:()) {
  @include setup-margins-per-query(null, $options);
}